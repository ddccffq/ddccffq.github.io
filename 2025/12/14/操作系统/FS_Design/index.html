

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ddccffq">
  <meta name="keywords" content="���,�㷨,����ѧϰ,���������,��������,��������,ѧϰ�ʼ�">
  
    <meta name="description" content="File System Def. File System: a layer of OS that transforms block interface of disks (or other block devices) into files, directories, etc… Components:  naming: interface to find files by name, not b">
<meta property="og:type" content="article">
<meta property="og:title" content="14: FS Design">
<meta property="og:url" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/index.html">
<meta property="og:site_name" content="ddccffq&#39;s Blog">
<meta property="og:description" content="File System Def. File System: a layer of OS that transforms block interface of disks (or other block devices) into files, directories, etc… Components:  naming: interface to find files by name, not b">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Example%20directory%20structure%20in%20Unix.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Example%20directory%20internals%20in%20Unix.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Multi-Level%20Index.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Sprase%20Files%20in%20FFS.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/MFT.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Small%20File.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Medium%20File.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Large%20or%20Fragmented%20File.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Multiple%20Indirect%20Blocks.png">
<meta property="og:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/VFS.png">
<meta property="article:published_time" content="2025-12-14T08:00:00.000Z">
<meta property="article:modified_time" content="2026-01-02T13:54:15.838Z">
<meta property="article:author" content="ddccffq">
<meta property="article:tag" content="���,�㷨,����ѧϰ,���������,��������,��������,ѧϰ�ʼ�">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ddccffq.github.io/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Example%20directory%20structure%20in%20Unix.png">
  
  
  
  <title>14: FS Design - ddccffq&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"ddccffq.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="14: FS Design"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-14 16:00" pubdate>
          2025年12月14日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          414 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          4 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">14: FS Design</h1>
            
            
              <div class="markdown-body">
                
                <span id="more"></span>
<h2 id="file-system">File System</h2>
<p><strong>Def</strong>. <strong>File System</strong>: a layer of OS that transforms <strong>block interface</strong> of disks (or other block devices) into files, directories, etc…</p>
<p>Components:</p>
<ul>
<li>naming: interface to <strong>find</strong> files by name, not by blocks</li>
<li><strong>disk management</strong>: collecting disk blocks into files</li>
<li><strong>protection</strong>: layers to keep data secure</li>
<li>reliability/durability: keeping of files durable despite crashes, media failures, attacks, etc…</li>
</ul>
<h2 id="disk-management-policies">Disk Management Policies</h2>
<ul>
<li>basic entities on a disk;
<ul>
<li><strong>file</strong>: user-visible group of blocks arranged sequentially in logical space</li>
<li><strong>directory</strong>: user-visible index mapping names to files</li>
</ul></li>
<li>access disk as linear array of sectors, two options:
<ul>
<li>identify sectors as vectors [cylinder, surface, sector], sort in cylinder-major order</li>
<li>logical Block Addressing (LBA, 逻辑块寻址): every sector has integer address from zero up to max number of sectors</li>
<li>controller translates from address <span class="math inline">\(\Rightarrow\)</span> physical position
<ul>
<li>first case: OS/BIOS must deal with bad sectors</li>
<li>second case: hardware shields OS from structure of disk</li>
</ul></li>
</ul></li>
<li>need way to track free disk blocks
<ul>
<li>link free blocks together <span class="math inline">\(\Rightarrow\)</span> too slow today</li>
<li><strong>use bitmap to represent free space on disk</strong></li>
</ul></li>
<li>need way to structure files: <strong>file header</strong>
<ul>
<li>track which blocks belong at which offsets within the logical file structure</li>
<li>optimize placement of files’ disk blocks to match access and usage patterns</li>
</ul></li>
</ul>
<h2 id="file">File</h2>
<p><strong>Def</strong>. <strong>File</strong>: named permanent storage. Contain:</p>
<ul>
<li><strong>data</strong>: <strong>blocks</strong> on disk somewhere</li>
<li><strong>metadata</strong>:
<ul>
<li>owner, size, last opened, …</li>
<li>access rights
<ul>
<li>R, W, X</li>
<li>owner, group, other (in Unix systems)</li>
<li>access control list in Windows system</li>
</ul></li>
</ul></li>
</ul>
<h2 id="directory">Directory</h2>
<p><strong>Def</strong>. <strong>Directory</strong>: basically a <strong>hierarchical</strong> structure. Contain</p>
<ul>
<li><strong>files</strong></li>
<li><strong>directories</strong>: a link to another entries</li>
</ul>
<p>Conventions of directory:</p>
<ul>
<li><strong>root directory</strong></li>
<li><strong>home directory</strong></li>
<li><strong>absolute path</strong></li>
<li><strong>relative path</strong></li>
</ul>
<p><strong>Def</strong>. <strong>Volume</strong>: a collection of physical storage resources that form a logical storage device. Could be a part of or many physical devices.</p>
<p><strong>Def</strong>. <strong>Mount</strong>: an operation that creates a mapping from some path in the existing file system to the root directory of the mounted volume’s file system.</p>
<h2 id="designing-a-file-system">Designing a File System</h2>
<ul>
<li>durable data store</li>
<li>disks performance</li>
<li>open before read/write
<ul>
<li>can perform protection checks and look up where the actual file resource are</li>
</ul></li>
<li>size is determined as they used
<ul>
<li>can write (or read zeros) to <strong>expand</strong> the file</li>
<li>start small and grow, need to make room</li>
</ul></li>
<li>organized into directories</li>
<li>need to allocate/free blocks</li>
</ul>
<h2 id="inode">inode</h2>
<p><strong>Def</strong>. An <strong>inode</strong> is a data structure on a filesystem on Linux and other Unix-like operating systems that stores all the information about a file except its name and its actual data.</p>
<p>Each file has exactly one corresponding one inode?</p>
<ul>
<li>true for most traditional Unix-like filesystems</li>
<li>no true with hard links</li>
</ul>
<blockquote>
<p>When a file is copied - a new inode when a file is moved - nothing changed (unless to another filesystem)</p>
<p>How many inodes in Linux？For 32-bit inode number, it’s <span class="math inline">\(2^{32}\)</span>. It also configurable in many file systems</p>
</blockquote>
<h2 id="typical-file-systems">Typical File Systems</h2>
<ul>
<li>FAT (Microsoft File Allocation Table), 1970s.
<ul>
<li>extremely simple index structure: a linked list.</li>
<li>still widely used in devices like flash memory sticks and digital cameras</li>
</ul></li>
<li>FFS (Unix Fast File System), 1980s.
<ul>
<li>tree-based multilevel index to improve random access efficiency.</li>
<li>uses a collection of locality heuristics to get good spatial locality.</li>
<li>EXT2 and EXT3 are based on FFS.</li>
</ul></li>
<li>NTFS (Microsoft NewTechnology File System): 1990s.
<ul>
<li>more flexible tree structure.</li>
<li>mainstream file system on MS.</li>
<li>it’s representative to EXT4, XFS, and Apple’s Hierarchical File Systems (HFS and HFS+).</li>
</ul></li>
</ul>
<h2 id="how-do-we-convert-a-file-name-to-the-file-number">How do we convert a file name to the file number?</h2>
<h3 id="directory-structure">Directory Structure</h3>
<ul>
<li>Directory is treated as a file with a list of <code>&lt;file name: file number&gt;</code> mappings</li>
<li>The file number of the root directory is agreed ahead of time (in many Unix FSs. it’s 2).</li>
</ul>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Example%20directory%20structure%20in%20Unix.png" srcset="/img/loading.gif" lazyload alt="Example directory structure in Unix"><figcaption aria-hidden="true">Example directory structure in Unix</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 1: Example directory structure in Unix
</div>
<ul>
<li>Stored in files, can be read, but typically don’t
<ul>
<li>System calls to access directories</li>
<li><code>open</code> / <code>creat</code> traverse the structure</li>
<li><code>mkdir</code> / <code>rmdir</code> add/remove entries</li>
<li><code>link</code> / <code>unlink</code>
<ul>
<li>Link existing file to a directory
<ul>
<li>Not in <strong>FAT</strong>!</li>
</ul></li>
<li>Forms a <strong>DAG</strong></li>
</ul></li>
</ul></li>
<li>When can file be <strong>deleted</strong>?
<ul>
<li>Maintain re-count of links to the file.</li>
<li>Delete after the last reference is gone.</li>
</ul></li>
<li>libc support
<ul>
<li><code>DIR * opendir(const char *dirname)</code></li>
<li><code>struct dirent * readdir(DIR *dirstream)</code></li>
<li><code>int readdir_r(DIR *dirstream, struct dirent *entry, struct dirent **result)</code></li>
</ul></li>
</ul>
<h3 id="directory-internals">Directory Internals</h3>
<p>Early implementations simply stored <strong>linear lists</strong> of <code>&lt;file name, file number&gt;</code> in directory files.</p>
<ul>
<li>Free spaces are for new entries. Note: files can be added/deleted.</li>
</ul>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Example%20directory%20internals%20in%20Unix.png" srcset="/img/loading.gif" lazyload alt="Example directory internals in Unix"><figcaption aria-hidden="true">Example directory internals in Unix</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 2: Example directory internals in Unix
</div>
<blockquote>
<p>Works fine in most cases. But when there are thousands of files in a directory. The access could be <strong>slow</strong>!</p>
<p>其中 <code>.</code> 是当级目录，<code>..</code> 是上级目录</p>
</blockquote>
<p>Modern FSs (Linux XFS, Microsoft NTFS, and Oracle ZFS) organize directory’s contents as a <strong>tree</strong>.</p>
<ul>
<li><strong>B/B<sup>+</sup></strong> tree: fast lookup, insert, and removal.</li>
<li>Names are first <strong>hashed into a key</strong>, which is used to find the file number in the tree.</li>
</ul>
<h3 id="directory-structure-access-cost">Directory Structure Access Cost</h3>
<p>How many disk accesses to resolve <code>/my/book/count</code>?</p>
<ul>
<li>Read in file header for <strong>root</strong> (fixed spot on disk)</li>
<li>Read in first <strong>data block</strong> for root
<ul>
<li>Table of file name/index pairs. Search linearly - ok since directories typically very small</li>
</ul></li>
<li>Read in file header for <code>my</code></li>
<li>Read in first data block for <code>my</code>; search for <code>book</code></li>
<li>Read in file header for <code>book</code></li>
<li>Read in first data block for <code>book</code>; search for <code>count</code></li>
<li>Read in file header for <code>count</code></li>
</ul>
<p><strong>Current working directory</strong>: per-address-space pointer to a directory (inode) used for resolving file names</p>
<ul>
<li>Allow user to specify relative filename instead of absolute path</li>
</ul>
<h3 id="hard-link">Hard Link</h3>
<ul>
<li><code>ln</code> command - <code>link()</code>
<ul>
<li>It creates another name in the directory you are creating the link to, and refers it to the <strong>same inode number</strong> of the original file.</li>
<li>OS maintains a reference count for each inode</li>
</ul></li>
</ul>
<blockquote>
<p>When shall I use hard link?</p>
<ul>
<li>I don’t want to increase inode number</li>
<li>I want the linked file/directory keep working even when the original file/directory is deleted</li>
<li><strong>version control</strong></li>
</ul>
</blockquote>
<h3 id="soft-link">Soft Link</h3>
<ul>
<li><code>ln -s</code> command - soft (or symbolic) <code>link()</code>
<ul>
<li>A special type of file (as against regular file/dir) whose contents are the <strong>pathname</strong> of the linked-to file.</li>
</ul></li>
</ul>
<blockquote>
<p>When shall I use soft link?</p>
<ul>
<li>I want to link to a directory. Using hard link to directory might result in cycle in the directory tree.</li>
<li>I want to link to files in other disk partitions. Because inode numbers are only unique within a particular file system, not across file systems.</li>
<li><strong>shortcuts</strong> (快捷访问)</li>
</ul>
</blockquote>
<h2 id="how-do-we-locate-storage-block-based-on-file-number">How do we locate storage block based on file number?</h2>
<h3 id="fat-file-allocation-table">FAT (File Allocation Table)</h3>
<ul>
<li>FAT is a linked list as 1-1 map with blocks
<ul>
<li>represented as a list of 32-bit entries</li>
</ul></li>
<li>each entry in FAT contains a pointer to the next FAT <strong>entry</strong> of the same file</li>
<li>where is FAT stored?
<ul>
<li>on disk, on boot cache in memory, second (backup) copy on disk</li>
</ul></li>
<li><strong>free space</strong>: FAT free <strong>list</strong>, i.e., <code>FAT[i] = 0</code> (i-th block is free space)</li>
<li>locality (storing a file in sequential blocks) is important for fast I/O
<ul>
<li>sequential I/O is much faster than random I/O</li>
<li>imagine you want to append 100 MB to a 200 MB file, FS cannot guarantee they are stored sequential</li>
</ul></li>
</ul>
<blockquote>
<p>How to ensure good locality heuristics in FAT?</p>
<ul>
<li>simple strategy: <code>next fit</code>, i.e, scans sequentially through the FAT <strong>starting from the last entry that was allocated</strong> and return the next free entry</li>
<li>still, there will be increasing fragment</li>
<li>defragmentation tool: read files and rewrite them to new locations with better locality</li>
</ul>
</blockquote>
<ul>
<li>READ: just get block by block with FAT</li>
<li>WRITE
<ul>
<li>get blocks from free list</li>
<li>linking them into a file</li>
</ul></li>
<li>format a disk
<ul>
<li>zero the blocks, link up the FAT free list</li>
</ul></li>
<li>quick format
<ul>
<li>link up the FAT free list</li>
</ul></li>
</ul>
<blockquote>
<p>Issues</p>
<ul>
<li><strong>poor locality</strong>: there will be fragmentation</li>
<li><strong>poor random access</strong>: need to traverse the file’s FAT entries till the block is reached</li>
<li>file metadata stored in directory entries, therefore being limited
<ul>
<li>only has file’s name, size, and creation time, but cannot specify the file’s owner or group</li>
</ul></li>
<li>limitations on volume and file size
<ul>
<li>with top 4 bits reserved.</li>
<li><span class="math inline">\(2^{28}\)</span> blocks <span class="math inline">\(\times\)</span> <span class="math inline">\(4\)</span> KB block size</li>
<li>large block size</li>
<li>file size is encoded in <span class="math inline">\(32\)</span> bits, so less than <span class="math inline">\(4\)</span> GB</li>
</ul></li>
<li>no support for hard links, hard to maintain a link count (not use inode)</li>
</ul>
</blockquote>
<h3 id="unix-file-system-fast-file-system-ffs">Unix File System (Fast File System FFS)</h3>
<blockquote>
<p>File Number is index into inode arrays.</p>
</blockquote>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Multi-Level%20Index.png" srcset="/img/loading.gif" lazyload alt="Multi-Level Index"><figcaption aria-hidden="true">Multi-Level Index</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 3: Multi-Level Index
</div>
<blockquote>
<p>Data block’s size is <span class="math inline">\(4\)</span> KB</p>
<p>Indirect pointers: point to a disk block containing only pointers</p>
<p><span class="math inline">\(4\)</span> KB blocks <span class="math inline">\(\Rightarrow\)</span> <span class="math inline">\(1024\)</span> ptrs (each pointer with <span class="math inline">\(4\)</span> bytes size)</p>
<ul>
<li>indirect pointer <span class="math inline">\(\Rightarrow\)</span> <span class="math inline">\(4\)</span> MB</li>
<li>double indirect pointer <span class="math inline">\(\Rightarrow\)</span> <span class="math inline">\(4\)</span>GB</li>
<li>triple indirect pointer <span class="math inline">\(\Rightarrow\)</span> <span class="math inline">\(4\)</span>TB</li>
</ul>
<p>The maximal file size is <span class="math inline">\(4 \text{KB} \times 12 + 4 \text{MB} + 4 \text{GB} + 4 \text{TB}\)</span> The maximal disk size is <span class="math inline">\(2^{32} \times 4 \text{KB} = 16 \text{TB}\)</span></p>
</blockquote>
<p>Characteristics:</p>
<ul>
<li><strong>tree structure</strong></li>
<li><strong>high degree</strong>: the FFS tree uses internal nodes with many children.</li>
<li><strong>fixed structure</strong></li>
<li><strong>asymmetric</strong></li>
</ul>
<p>FFS can support sparse files, in which one or more ranges of empty space are surrounded by file data. Those empty space shall not consume disk space.</p>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/Sprase%20Files%20in%20FFS.png" srcset="/img/loading.gif" lazyload alt="Sparse Files in FFS"><figcaption aria-hidden="true">Sparse Files in FFS</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 4: Sparse Files in FFS
</div>
<p>Pros</p>
<ul>
<li>efficient storage for both small and large files</li>
<li>locality for both small and large files</li>
<li>locality for metadata and data</li>
<li>no defragmentation necessary</li>
</ul>
<p>Cons</p>
<ul>
<li>inefficient for tiny files (a 1 byte file requires both an inode and a data block)</li>
<li>inefficient encoding when file is mostly contiguous on disk</li>
<li>need to reserve 10-20% of free space to prevent fragmentation</li>
</ul>
<h4 id="free-space-management">Free Space Management</h4>
<ul>
<li>FFS allocates a bitmap with one bit per storage block. The i-th bit in the bitmap indicates whether the i-th blocks is free or in use</li>
<li>the position of FFS’s bitmap is fixed when the file system is formatted. So it is easy to find the part of the bitmap that identifies free blocks near any location of interest</li>
</ul>
<h4 id="locality-heuristics">Locality Heuristics</h4>
<ul>
<li><strong>block group placement</strong>: FFS places data to optimize for the common case where a file’s data blocks, a file’s data and metadata, and different files from the same directory are accessed together
<ul>
<li>files in the same directory are placed in the same block group
<ul>
<li>the same for the “directory file” as well, i.e., when a new file is created, find an inode number within the block where its directory resides and give it to the file</li>
</ul></li>
<li>but don’t put the directory and its sub-directory together</li>
<li><strong>First-Free</strong> allocation of new file blocks</li>
</ul></li>
<li><strong>reserved space</strong>: FFS reserves some fraction of the disk’s space (e.g., 10%) and presents a slightly reduced disk size to applications
<ul>
<li>when disk is full, there’s little opportunity for file system to optimize locality</li>
<li>sacrifices a little disk capacity for better locality thus reduced seek times</li>
</ul></li>
</ul>
<h3 id="new-technology-file-system-ntfs">New Technology File System (NTFS)</h3>
<blockquote>
<p>Block size variable</p>
</blockquote>
<p><strong>Def</strong>. <strong>Master File Table</strong></p>
<ul>
<li>database with flexible <span class="math inline">\(1\)</span>KB entries for metadata/data</li>
<li>variable-sized attribute records (data or metadata)</li>
<li>extend with variable depth tree (non-resident attribute, 非常驻属性)</li>
</ul>
<p>Extents – variable length contiguous regions</p>
<ul>
<li>block pointers cover runs of blocks</li>
</ul>
<p>Journal for reliability</p>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/MFT.png" srcset="/img/loading.gif" lazyload alt="MFT"><figcaption aria-hidden="true">MFT</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 5: MFT
</div>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Small%20File.png" srcset="/img/loading.gif" lazyload alt="NTFS Small File"><figcaption aria-hidden="true">NTFS Small File</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 6: NTFS Small File
</div>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Medium%20File.png" srcset="/img/loading.gif" lazyload alt="NTFS Medium File"><figcaption aria-hidden="true">NTFS Medium File</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 7: NTFS Medium File
</div>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Large%20or%20Fragmented%20File.png" srcset="/img/loading.gif" lazyload alt="NTFS Large or Fragmented File"><figcaption aria-hidden="true">NTFS Large or Fragmented File</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 8: NTFS Large or Fragmented File
</div>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/NTFS%20Multiple%20Indirect%20Blocks.png" srcset="/img/loading.gif" lazyload alt="NTFS Multiple Indirect Blocks"><figcaption aria-hidden="true">NTFS Multiple Indirect Blocks</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 9: NTFS Multiple Indirect Blocks
</div>
<h2 id="virtual-file-system-vfs">Virtual File System (VFS)</h2>
<div style="display: block; margin: 0 auto; width: fit-content">
<figure>
<img src="/2025/12/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/FS_Design/VFS.png" srcset="/img/loading.gif" lazyload alt="VFS"><figcaption aria-hidden="true">VFS</figcaption>
</figure>
</div>
<div style="text-align: center; font-style: italic;">
Figure 10: VFS
</div>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/The-Operating-System/" class="category-chain-item">The Operating System</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>14: FS Design</div>
      <div>https://ddccffq.github.io/2025/12/14/操作系统/FS_Design/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>ddccffq</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月14日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/12/15/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Reliable_FS/" title="Reliable FS">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Reliable FS</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/12/08/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/IO_Devices_and_Disk/" title="IO Devices and Disk">
                        <span class="hidden-mobile">IO Devices and Disk</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"ddccffq/ddccffq.github.io","repo-id":"R_kgDOPtFBqg","category":"Announcements","category-id":"DIC_kwDOPtFBqs4CvlN9","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"bottom","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <br> <span>&copy; 2025 <a href="https://github.com/ddccffq" target="_blank">ddccffq</a>. All Rights Reserved.</span> <br> <span style="font-size: 12px; color: #999;">用代码改变世界，以技术创造价值</span> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
